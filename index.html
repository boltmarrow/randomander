<!DOCTYPE html>
<html>
<body>
    <h1>RANDOMANDER</h1>
    <p>A customizable & filterable random commander generator for Magic: the Gathering</p>
    
    <form>
            <label for="filter">Filters (scryfall search syntax): </label><br>
            <input type="text" id="filter" name="filter" placeholder="mv=4 o:draw" oninput="filterUpdate()"><br>
            <label for="displayCnt">Max cards to display at once: </label>
            <input type="number" id="displayCnt" name="displayCnt" min="1" max="50" value="5"><br>
    </form>

    <button type="button" id="loadDocButton" onclick="loadDoc()">Get Commanders</button>
    <div id="outputDiv"></div>
<script>

// global list of cards to pick commanders from (for use across async API requests)
var cardList = [];
// global var to track last searched filter
var lastFilter = "";

// display some html in the output div
function outputHTML(out) {
    document.getElementById("outputDiv").innerHTML = out;
}
// updates the form when the filter is changed to signal slower loading times (requests cached are filter-specific)
function filterUpdate() {
    let out;
    if (document.getElementById("filter").value == lastFilter) {
        // filter hasn't changed from last search
        out = "Reroll Commanders (same filter)";
        console.log(`same`);
    } else {
        out = "Get Commanders";
        console.log(`diff is prev "${lastFilter}", now "${document.getElementById("filter").value}"`);
    }

    document.getElementById("loadDocButton").innerHTML = out;
}

function loadDoc() {
    // clear global card list from last iteration
    cardList = [];
    // new https request
    var xhttp = new XMLHttpRequest();

    // when our request is returned
    xhttp.onreadystatechange = function() {
        // if we got a resposne
        if (this.readyState == 4) {
            // on bad status, throw error and exit
            if (this.status == 404) {
                outputHTML(`<p>No results :(</p>`);
                return;
            // any other non-OK status
            } else if (this.status != 200) {
                outputHTML(`<p>${this.status} query error :(</p>`);
                return; 
            }

            let responseText = JSON.parse(this.responseText);
            // add returned cards to global list
            cardList = cardList.concat(responseText.data);

            // debug info
            // console.log("parsed responseText:");
            // console.log(responseText);

            // if there are more pages of cards, post new request and return
            if (responseText.has_more) {
                xhttp.open("GET", responseText.next_page, true);
                xhttp.send();
                // show progress to user
                outputHTML(`Loaded ${cardList.length} of ${responseText.total_cards} cards...`);

                return;
            }

            // number of cards to display
            let i_max = document.getElementById("displayCnt").value
            // html to be rendered
            let output = "";

            // render the requested number of commanders
            for(let i = 0; i < i_max; i++) {
            
                // random index in bounds
                let idx = Math.floor(Math.random() * cardList.length);
                
                // add to HTML being rendered
                // if we can't find the image URI check for MDFC
                // if that doesn't work either give up and log to console
                try {
                    if (cardList[idx].image_uris) {
                        output += "<img src=" + cardList[idx].image_uris.normal + "> ";
                    } else {
                        output += "<img src=" + cardList[idx].card_faces[0].image_uris.normal + "> ";
                    }
                } catch (err) {
                    console.log("failed to get URI for card " + cardList[idx].name);
                }
                // remove card from list for future iterations
                cardList.splice(idx, 1);
                // if the list is empty now, break
                if (cardList.length == 0) break;

            }
            // render cards
            outputHTML(output);
        }
    };

    // build request from inputs and commanders only
    let filter = encodeURIComponent(document.getElementById("filter").value + " is:commander legal:commander");
    // console.log(filter);

    // send request to scryfall
    xhttp.open("GET", "https://api.scryfall.com/cards/search?q=" + filter, true);
    xhttp.send();
    // put notification in output div
    outputHTML("<p>Working...</p>");
    // update last used filter
    lastFilter = document.getElementById("filter").value // not the part we secretly append
    // simulate filter update
    filterUpdate();
}

</script>
</body>
</html>